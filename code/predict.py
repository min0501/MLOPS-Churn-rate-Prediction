# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1CvOKdFJ-3xO06_C1aqzF0qGZ6TyBAotV
"""

import pandas as pd
import joblib
from retrain import (
    client_nums, genders, income_categories, education_levels,
    marital_statuses, X_test_new, y_test_new, model_performance
)

# Load the retrained model
ensemble_model = joblib.load('retrained_model.pkl')

# Predict churn probabilities on the new test data
y_test_new_pred = ensemble_model.predict_proba(X_test_new)['ensemble']  # Assuming the model has a predict_proba method

# Save predictions
predictions = pd.DataFrame({
    '고객번호': client_nums.iloc[X_test_new.index].values,
    '성별': genders.iloc[X_test_new.index].values,
    '소득': income_categories.iloc[X_test_new.index].values,
    '교육수준': education_levels.iloc[X_test_new.index].values,
    '결혼상태': marital_statuses.iloc[X_test_new.index].values,
    '예측이탈률': y_test_new_pred,
    '예측이탈여부': y_test_new.values
})
top_10_churn = predictions.nlargest(10, '예측이탈률')

# Save the data for the dashboard
predictions.to_csv('new_data_predictions.csv', index=False)
top_10_churn.to_csv('top_10_churn.csv', index=False)
joblib.dump(model_performance, 'model_performance.pkl')